#! /bin/sh
# $Id$
set -e
root=$(cd $(dirname "$0"); pwd)
basename=$(basename "$0")
libdir=$(cd "$root"/../lib/sldata; pwd)
timestamp=$(echo '$Date$'|cut -d' ' -f2)
version=1

do_usage() {
  cat <<EOF
Usage: $0 [OPTION] PROGRAM [ARGS]...

Run a compiled SVP program.

Options:
  -r runner      Use the specified runner (may be cce string).

  -x             Show configuration string embedded in program (if any).

  -h, --help     Print this help, then exit.

  -v, --version  Print version number, then exit.

Report bugs and patches to the CSA Trac issue tracker, or to
<r.c.poss@.uva.nl>.
EOF
  exit 0
}

do_version() {
  rev='$Rev$'
  rev=$(echo "$rev"|cut -d' ' -f2)
  cat <<EOF
$basename $version.$rev ($timestamp)

This script is copyright (C) 2009 the CSA group - Universiteit
van Amsterdam.
EOF
  exit 0
}


# Command line analysis
prev_arg=
show_embedded=
for arg in "$@"; do
  # if the previous option needs an argument, assign it
  if test -n "$prev_arg"; then
     eval "$prev_arg=\$arg"
     prev_arg=
     shift
     continue
  fi
  case $arg in
      -r)	prev_arg=runner; shift;;
      -x)	show_embedded=1; shift;;
      -v|--version)	do_version;;
      -h|--help)	do_usage;;
      --)  break;;
      -*) echo "$0: unrecognized command-line argument: $arg (try -h)" >&2; exit 1;;
      *)   break;;
  esac
done

program=$1
shift

# does the program exist?
if ! test -f "$program"; then
  echo "$0: program not found: $program" >&2
  exit 127
fi

if test -n "$show_embedded" -o -z "$runner"; then
  tag=$(strings "$program"|grep 'sc-tag:.*:'|tail -n1|cut -d: -f2)
  if test "x$tag" = "x"; then
    if test -n "$show_embedded"; then
       echo "(none found)"
       exit 0    
    fi
  else
    if test -n "$show_embedded"; then
       echo "$tag"
       exit 0    
    fi
    runner=$(echo "$tag"|cut -d- -f7)
  fi
fi

if test -n "$runner"; then
  # Runner specified, check it
  if ! test -f "$libdir/cfg/r-$runner"; then
     # try CCE instead
     str=$("$root"/cce -c "$runner")
     runner=$(echo "$str"|cut -d- -f7)
  fi
fi

SLC_MODE=run exec $SHELL "$libdir/cfg/r-$runner" "$program" "$@"
