#! /bin/sh
# $Id$
#
if test $# -lt 1; then
  cat >&2 <<EOF
usage: $0 <commandline ...>

Execute a program and force terminate its execution
if it does not terminate normally before a timeout.

The exit code is 137 if the timeout expires before the command
terminates. The default timeout is 5 seconds. 
Change with environment variable TIMEOUT.
EOF
  exit 1
fi

set -m

TIMEOUT=${TIMEOUT:-5}
cmdpid=
kpid=
dokill() {
  sig=$1
  echo "received $sig!"
  if test -n "$cmdpid"; then kill -$sig "$cmdpid"; fi
  if test -n "$kpid"; then kill -HUP "$kpid"; fi
  exit $(expr $sig + 128)
}

trap 'dokill 1' 1
trap 'dokill 2' 2
trap 'dokill 3' 3
trap 'dokill 15' 15

"$@" &
cmdpid=$!
(
  trap 'kill -KILL $sleep' HUP
  sleep "$TIMEOUT" &
  sleep=$!
  wait $sleep
  if test $? = 0; then kill -KILL $cmdpid >/dev/null 2>&1; fi
) &
kpid=$!
wait $cmdpid
result=$?
kill -HUP $kpid >/dev/null 2>&1
exit $result

# -*- mode: shell -*-
