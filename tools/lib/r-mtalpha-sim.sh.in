#! /bin/sh
# $Id$
set -eu
MGSIM_ALPHA=${MGSIM_ALPHA:-@MGSIM_ALPHA@}
basename=${0##*/}
program=${1:?}
datafile=${2:?}
fdatafile=${3:?}
DEBUGGER=${DEBUGGER:-gdb --args}
shift
shift
shift
if ! test -x "$program"; then
    echo "$basename: $program: not an executable" >&2
    exit 1
fi
if ! test -r "$datafile"; then
    echo "$basename: $datafile: file not found or not readable" >&2
    exit 1
fi

if ! test -r "$fdatafile"; then
    echo "$basename: $fdatafile: file not found or not readable" >&2
    exit 1
fi

if ! "$MGSIM_ALPHA" --help >/dev/null 2>&1; then
  echo "$basename: cannot find simulator (MGSIM_ALPHA=$MGSIM_ALPHA)." >&2
  exit 1
fi

if test -n "${NCORES:-}"; then
   SIMARGS="${SIMARGS:-} -o NumProcessors=$NCORES"
fi

do_debug=
if test -n "${DEBUG:-}"; then
   SIMARGS="${SIMARGS:-} -i"
   do_debug=$DEBUGGER
fi

if test -n "${VERBOSE:-}"; then
    echo "$basename: running: ${RUNNER_PREFIX:-} $do_debug $MGSIM_ALPHA ${SIMARGS:-} -t ${*:-} -L16 $datafile -L17 $fdatafile $program" >&2
fi  
set +u
exec ${RUNNER_PREFIX:-} $do_debug $MGSIM_ALPHA ${SIMARGS:-} -t "$@" -L16 "$datafile" -L17 "$fdatafile" "$program"
